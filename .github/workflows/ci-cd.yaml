name: CI-CD

# 觸發條件：任何分支 push 都會跑 build；只有 main 會跑 deploy
on:
  push:

jobs:
  # ============================================
  # Job 1: 建置與檢查（所有分支都會執行）
  # ============================================
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      # 使用 Bun 進行依賴安裝和建置（比 Node.js 更快）
      - name: Install Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      # 執行建置流程（使用獨立腳本文件）
      - name: Build Application
        run: |
          chmod +x .github/scripts/build.sh
          .github/scripts/build.sh

  # ============================================
  # Job 2: 部署（僅 main 分支觸發；需 build 成功）
  # ============================================
  deploy:
    if: github.ref == 'refs/heads/main'
    needs: build
    runs-on: ubuntu-latest

    env:
      SSH_USER: ${{ vars.VAR_SSH_USER }}
      SSH_PORT: ${{ vars.VAR_SSH_PORT }}
      SSH_HOST: ${{ secrets.SSH_HOST }}
      # 部署腳本路徑（可直接在此修改）
      DEPLOY_SCRIPT_PATH: ./deploy.sh
      # 更新腳本路徑（可直接在此修改）
      UPDATE_SCRIPT_PATH: ./update.sh

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v5

      # 設置 SSH（使用獨立腳本文件）
      - name: Setup SSH
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          SSH_KEY_PASSPHRASE: ${{ secrets.SSH_KEY_PASSPHRASE }}
        run: |
          chmod +x .github/scripts/setup-ssh.sh
          .github/scripts/setup-ssh.sh

      # 執行部署流程（使用獨立腳本文件）
      - name: Deploy to Server
        run: |
          chmod +x .github/scripts/deploy.sh
          .github/scripts/deploy.sh
