name: CI-CD

# 觸發條件：任何分支 push 都會跑 build；只有 main 會跑 deploy
on:
  push:

jobs:
  # ============================================
  # Job 1: 建置與檢查（所有分支都會執行）
  # ============================================
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      # 使用 Bun 進行依賴安裝和建置（比 Node.js 更快）
      - name: Install Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      # 安裝依賴（Bun 會自動使用 lockfile 確保一致性）
      - name: Install Dependencies
        run: bun install --frozen-lockfile

      # 複製 .env.example 為 .env（用於建置時需要的環境變數）
      - name: Setup Environment Files
        run: |
          find . -type f -name ".env.example" -exec sh -c 'cp "$1" "${1%.*}"' _ {} \;

      # 執行 ESLint 檢查
      - name: Run Linter
        run: bun lint

      # 建置 Next.js 應用程式
      - name: Build Application
        run: bun run build

  # ============================================
  # Job 2: 部署（僅 main 分支觸發；需 build 成功）
  # ============================================
  deploy:
    if: github.ref == 'refs/heads/main'
    needs: build
    runs-on: ubuntu-latest

    env:
      SSH_USER: ${{ vars.VAR_SSH_USER }}
      SSH_PORT: ${{ vars.VAR_SSH_PORT }}
      SSH_HOST: ${{ secrets.SSH_HOST }}
      # 部署腳本路徑（可直接在此修改）
      DEPLOY_SCRIPT_PATH: ./deploy.sh
      # 更新腳本路徑（可直接在此修改）
      UPDATE_SCRIPT_PATH: ./update.sh

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v5

      # 設置 SSH（合併多個步驟為一個，減少執行時間）
      - name: Setup SSH
        env:
          SSH_KEY_PASSPHRASE: ${{ secrets.SSH_KEY_PASSPHRASE }}
        run: |
          set -euo pipefail

          echo "::group::[DEBUG] Setting up SSH connection"

          # 安裝 expect（用於自動輸入 passphrase）
          echo "::debug::Installing expect..."
          sudo apt-get update -qq && sudo apt-get install -y expect

          # 設置 SSH 目錄和權限
          echo "::debug::Creating SSH directory..."
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh

          # 寫入 SSH private key
          echo "::debug::Writing SSH private key..."
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_deploy
          chmod 600 ~/.ssh/id_deploy

          # 添加 known_hosts（跳過驗證以加快速度）
          echo "::debug::Adding host to known_hosts..."
          ssh-keyscan -p "${SSH_PORT}" -H "${SSH_HOST}" >> ~/.ssh/known_hosts 2>/dev/null || true
          chmod 644 ~/.ssh/known_hosts

          # 啟動 SSH agent 並添加 key（使用 expect 處理 passphrase）
          echo "::debug::Starting SSH agent..."
          eval "$(ssh-agent -s)"
          echo "SSH_AUTH_SOCK=${SSH_AUTH_SOCK}" >> $GITHUB_ENV
          echo "SSH_AGENT_PID=${SSH_AGENT_PID}" >> $GITHUB_ENV

          # 使用 expect 自動輸入 passphrase
          echo "::debug::Adding SSH key to agent..."
          expect <<EOF
            set timeout 10
            spawn ssh-add ~/.ssh/id_deploy
            expect "Enter passphrase" { send "$SSH_KEY_PASSPHRASE\r" }
            expect eof
          EOF

          echo "::notice::SSH setup completed successfully"
          echo "::endgroup::"

      # 驗證部署腳本存在
      - name: Validate Scripts
        run: |
          echo "::group::[DEBUG] Validating deployment scripts"
          [ -f "${DEPLOY_SCRIPT_PATH}" ] || { echo "::error::Deploy script not found at ${DEPLOY_SCRIPT_PATH}"; exit 1; }
          [ -f "${UPDATE_SCRIPT_PATH}" ] || { echo "::error::Update script not found at ${UPDATE_SCRIPT_PATH}"; exit 1; }
          echo "::notice::All scripts validated successfully"
          echo "::endgroup::"

      # 上傳腳本並執行部署
      - name: Deploy to Server
        run: |
          set -euo pipefail

          echo "::group::[DEBUG] Starting deployment process"

          # 設置 SSH 選項（減少連接時間，增加穩定性）
          SSH_OPTS="-p ${SSH_PORT} -o StrictHostKeyChecking=no -o UserKnownHostsFile=~/.ssh/known_hosts -o ServerAliveInterval=10 -o ServerAliveCountMax=12 -o TCPKeepAlive=yes -o ConnectTimeout=30"

          # 檢查是否為首次部署（檢查 deploy.sh 是否存在）
          echo "::debug::Checking if this is first-time deployment..."
          IS_FIRST_DEPLOY=$(ssh $SSH_OPTS "${SSH_USER}@${SSH_HOST}" "[ -f ~/deploy.sh ] && echo 'no' || echo 'yes'")

          if [ "$IS_FIRST_DEPLOY" = "yes" ]; then
            echo "::notice::First-time deployment detected"
          else
            echo "::notice::Update deployment detected"
          fi

          # 上傳腳本到遠端
          echo "::debug::Uploading deployment scripts..."
          scp $SSH_OPTS "${UPDATE_SCRIPT_PATH}" "${SSH_USER}@${SSH_HOST}:~/update.sh"
          scp $SSH_OPTS "${DEPLOY_SCRIPT_PATH}" "${SSH_USER}@${SSH_HOST}:~/deploy.sh"
          echo "::notice::Scripts uploaded successfully"

          # 執行遠端部署邏輯
          # 策略：只要 ~/deploy.sh 存在就視為已部署過，只執行 update.sh
          echo "::debug::Executing remote deployment..."
          ssh $SSH_OPTS "${SSH_USER}@${SSH_HOST}" "chmod +x ~/deploy.sh ~/update.sh && if [ \"$IS_FIRST_DEPLOY\" = 'yes' ]; then ~/deploy.sh; else ~/update.sh; fi"

          echo "::notice::Deployment completed successfully"
          echo "::endgroup::"
